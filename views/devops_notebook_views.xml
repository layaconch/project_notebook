<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <record id="view_devops_notebook_list" model="ir.ui.view">
        <field name="name">devops.notebook.list</field>
        <field name="model">devops.notebook</field>
        <field name="arch" type="xml">
            <list string="笔记本" default_order="write_date desc">
                <field name="name"/>
                <field name="project_id"/>
                <field name="data_source_id"/>
                <field name="owner_id"/>
                <field name="cell_total"/>
                <field name="execution_count"/>
                <field name="failed_cells"/>
                <field name="last_run"/>
            </list>
        </field>
    </record>



    <!-- Action used by form header button; keep before view to avoid forward-ref issues -->
    <record id="action_devops_notebook_cell_add" model="ir.actions.act_window">
        <field name="name">添加单元格</field>
        <field name="res_model">devops.notebook.cell</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{'default_notebook_id': active_id}</field>
    </record>

    <record id="view_devops_notebook_form" model="ir.ui.view">
        <field name="name">devops.notebook.form</field>
        <field name="model">devops.notebook</field>
        <field name="arch" type="xml">
            <form string="Notebook" class="o_devops_notebook">
                <header>
                    <button name="action_run_all" type="object" string="Run All" class="btn-primary"/>
                    <field name="data_source_id" readonly="1" class="ms-2" optional="show"/>
                    <button name="action_configure_schedule"
                            type="object"
                            string="配置执行计划"
                            class="oe_highlight"/>
                    <button name="action_open_run_history"
                            type="object"
                            string="查看执行历史"
                            class="oe_link"/>
                    <button name="action_clear_all_outputs"
                            type="object"
                            string="清空全部输出"
                            class="btn-secondary"
                            confirm="确认清空该笔记本所有单元格的输出？"/>
                    <button name="%(action_devops_notebook_cell_add)d"
                            type="action"
                            string="添加单元格"
                            class="btn-secondary"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_open_project_wiki"
                                type="object"
                                class="oe_stat_button"
                                invisible="not project_id">
                            <field name="wiki_page_count" string="Wiki Pages" widget="statinfo"/>
                        </button>
                    </div>
                    <div class="o_devops_layout">
                        <div class="o_devops_meta_panel">
                            <group class="o_devops_meta_fields">
                                <field name="name"/>
                                <field name="project_id" options="{'no_create': False}"/>
                                <field name="owner_id" options="{'no_create': True}"/>
                                <field name="data_source_id" options="{'no_create': False}"/>
                                <field name="execution_mode" widget="devops_execution_mode"/>
                                <field name="cell_total" readonly="1"/>
                                <field name="execution_count" readonly="1"/>
                                <field name="failed_cells" readonly="1"/>
                                <field name="last_run" readonly="1"/>
                            </group>
                            <group string="笔记本说明" class="o_devops_meta_description">
                                <field name="description"
                                       widget="text"
                                       placeholder="Notebook description, tags..."
                                       options="{'no_quick_create': True}"/>
                            </group>
                            <group string="单元格状态" class="o_devops_meta_outline">
                                <field name="cell_ids" readonly="1">
                                    <list string="单元格状态">
                                        <field name="sequence"/>
                                        <field name="cell_type"/>
                                        <field name="status"/>
                                    </list>
                                </field>
                            </group>
                            <div class="o_devops_meta_stats o_notebook_stats">
                                <div class="o_stat_box">
                                    <div class="o_stat_label">单元总数</div>
                                    <field name="cell_total" readonly="1"/>
                                </div>
                                <div class="o_stat_box">
                                    <div class="o_stat_label">执行次数</div>
                                    <field name="execution_count" readonly="1"/>
                                </div>
                                <div class="o_stat_box">
                                    <div class="o_stat_label">失败单元</div>
                                    <field name="failed_cells" readonly="1"/>
                                </div>
                                <div class="o_stat_box">
                                    <div class="o_stat_label">最后运行时间</div>
                                    <field name="last_run" readonly="1"/>
                                </div>
                            </div>
                        </div>
                        <div class="o_devops_nb_workspace o_devops_nb_main">
                            <div class="o_devops_nb_editor">
                                <field name="cell_ids" context="{'default_notebook_id': id}">
                                    <kanban class="o_devops_nb_cells"
                                            quick_create="false"
                                            create="false"
                                            editable="false"
                                            default_group_by="">
                                        <field name="sequence"/>
                                        <field name="cell_label"/>
                                        <field name="cell_type"/>
                                        <field name="input_source"/>
                                        <field name="output_html"/>
                                        <field name="status"/>
                                        <templates>
                                            <t t-name="kanban-box">
                                                <div class="o_nb_cell">
                                                    <div class="o_nb_cell_header">
                                                        <span class="badge text-bg-secondary">
                                                            <field name="cell_label"/>
                                                        </span>
                                                        <span class="ms-2">
                                                            <field name="cell_type"/>
                                                        </span>
                                                        <div class="o_nb_cell_actions">
                                                            <button name="action_run"
                                                                    type="object"
                                                                    string="Run"
                                                                    class="btn btn-sm btn-primary me-2"/>
                                                            <button name="action_clear_output"
                                                                    type="object"
                                                                    string="清空输出"
                                                                    class="btn btn-sm btn-outline-secondary me-2"
                                                                    attrs="{'invisible': [('output_text','=',False), ('output_html','=',False)]}"/>
                                                            <button name="action_delete_cell"
                                                                    type="object"
                                                                    string="删除"
                                                                    class="btn btn-sm btn-outline-danger"
                                                                    confirm="确认删除该单元格？"/>
                                                        </div>
                                                    </div>
                                                    <div class="o_nb_cell_body">
                                                        <field name="input_source" widget="text" class="o_nb_input"/>
                                                    </div>
                                                    <div class="o_nb_cell_output">
                                                        <field name="output_html" widget="html" readonly="1" class="o_nb_output_html"/>
                                                    </div>
                                                    <div class="o_nb_cell_status">
                                                        <field name="status" widget="badge"/>
                                                    </div>
                                                </div>
                                            </t>
                                        </templates>
                                    </kanban>
                                </field>
                            </div>
                        </div>
                    </div>
                </sheet>
            </form>
        </field>
    </record>

    <record id="view_devops_notebook_search" model="ir.ui.view">
        <field name="name">devops.notebook.search</field>
        <field name="model">devops.notebook</field>
        <field name="arch" type="xml">
            <search string="Notebooks">
                <field name="name"/>
                <field name="project_id"/>
                <field name="owner_id"/>
                <filter name="has_failures" string="Has Errors" domain="[('failed_cells', '>', 0)]"/>
                <group expand="0" string="Group By">
                    <filter name="group_project" string="Project" context="{'group_by': 'project_id'}"/>
                    <filter name="group_owner" string="Owner" context="{'group_by': 'owner_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <record id="view_devops_notebook_cell_list" model="ir.ui.view">
        <field name="name">devops.notebook.cell.list</field>
        <field name="model">devops.notebook.cell</field>
        <field name="arch" type="xml">
            <list string="Notebook Cells" default_order="notebook_id,sequence">
                <field name="notebook_id"/>
                <field name="sequence"/>
                <field name="cell_type"/>
                <field name="status"/>
                <field name="last_run"/>
                <button name="action_run" string="Run" type="object" class="btn-link"/>
            </list>
        </field>
    </record>

    <record id="view_devops_notebook_cell_form" model="ir.ui.view">
        <field name="name">devops.notebook.cell.form</field>
        <field name="model">devops.notebook.cell</field>
        <field name="arch" type="xml">
            <form string="Notebook Cell" class="o_nb_modal_form">
                <header>
                    <button name="action_run" string="Run" type="object" class="btn-primary"/>
                </header>
                <sheet>
                    <group>
                        <field name="notebook_id"/>
                        <field name="sequence"/>
                        <field name="cell_type"/>
                        <field name="status" readonly="1"/>
                        <field name="elapsed_ms" readonly="1"/>
                    </group>
                    <field name="input_source" widget="text" class="o_nb_modal_input"/>
                    <field name="output_html" widget="html" readonly="1"/>
                </sheet>
            </form>
        </field>
    </record>

    <!-- 第二个重复的 list 视图删除 -->

    <record id="view_devops_notebook_schedule_tree" model="ir.ui.view">
        <field name="name">devops.notebook.schedule.tree</field>
        <field name="model">devops.notebook.schedule</field>
        <field name="arch" type="xml">
            <list string="Notebook Schedules">
                <field name="name"/>
                <field name="project_id"/>
                <field name="notebook_id"/>
                <field name="start_datetime"/>
                <field name="end_datetime"/>
                <field name="interval_number"/>
                <field name="interval_type"/>
                <field name="next_run"/>
                <field name="active"/>
            </list>
        </field>
    </record>

    <record id="view_devops_notebook_schedule_form" model="ir.ui.view">
        <field name="name">devops.notebook.schedule.form</field>
        <field name="model">devops.notebook.schedule</field>
        <field name="arch" type="xml">
            <form string="Notebook Schedule">
                <header>
                    <button name="action_run_now" type="object" string="Run Now" class="btn-primary"/>
                </header>
                <sheet>
                    <group>
                        <field name="notebook_id" options="{'no_create': False}"/>
                        <field name="name" string="Description" placeholder="Optional description"/>
                        <field name="active"/>
                    </group>
                    <group>
                        <field name="start_datetime"/>
                        <field name="end_datetime"/>
                    </group>
                    <group>
                        <field name="interval_number"/>
                        <field name="interval_type"/>
                        <field name="next_run" readonly="1"/>
                        <field name="last_run" readonly="1"/>
                        <field name="run_count" readonly="1"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_devops_notebook_schedule" model="ir.actions.act_window">
        <field name="name">Notebook Schedules</field>
        <field name="res_model">devops.notebook.schedule</field>
        <field name="view_mode">list,form</field>
    </record>

    <record id="view_devops_notebook_category_tree" model="ir.ui.view">
        <field name="name">devops.notebook.category.tree</field>
        <field name="model">devops.notebook.category</field>
        <field name="arch" type="xml">
            <list string="Notebook Categories">
                <field name="name"/>
                <field name="is_public"/>
                <field name="group_ids"/>
            </list>
        </field>
    </record>

    <record id="view_devops_notebook_category_form" model="ir.ui.view">
        <field name="name">devops.notebook.category.form</field>
        <field name="model">devops.notebook.category</field>
        <field name="arch" type="xml">
            <form string="Notebook Category">
                <sheet>
                    <group>
                        <field name="name"/>
                        <field name="is_public"/>
                        <field name="group_ids" widget="many2many_tags"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_devops_notebook_category" model="ir.actions.act_window">
        <field name="name">Notebook Categories</field>
        <field name="res_model">devops.notebook.category</field>
        <field name="view_mode">list,form</field>
    </record>

    <record id="view_devops_notebook_kanban" model="ir.ui.view">
        <field name="name">devops.notebook.kanban</field>
        <field name="model">devops.notebook</field>
        <field name="arch" type="xml">
            <kanban default_group_by="">
                <templates>
                    <t t-name="kanban-box">
                        <div class="o_kanban_record_card">
                            <div class="d-flex justify-content-between align-items-center">
                                <field name="name"/>
                                <span class="badge text-bg-secondary"><field name="owner_id"/></span>
                            </div>
                            <div class="text-muted small mt-1">
                                <span>Data Source:</span> <field name="data_source_id"/>
                                <span>Cells:</span> <field name="cell_total"/>
                                <span class="ms-2">Success:</span> <field name="execution_count"/>
                                <span class="ms-2">Failed:</span> <field name="failed_cells"/>
                            </div>
                            <div class="text-muted small">
                                <span>Last run:</span> <field name="last_run"/>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <record id="view_devops_notebook_graph" model="ir.ui.view">
        <field name="name">devops.notebook.graph</field>
        <field name="model">devops.notebook</field>
        <field name="arch" type="xml">
            <graph string="笔记本统计" type="bar">
                <field name="owner_id" type="row"/>
                <field name="cell_total" type="measure"/>
                <field name="execution_count" type="measure"/>
                <field name="failed_cells" type="measure"/>
            </graph>
        </field>
    </record>

    <record id="view_devops_notebook_pivot" model="ir.ui.view">
        <field name="name">devops.notebook.pivot</field>
        <field name="model">devops.notebook</field>
        <field name="arch" type="xml">
            <pivot string="Notebooks">
                <field name="owner_id" type="row"/>
                <field name="name" type="row"/>
                <field name="cell_total" type="measure"/>
                <field name="execution_count" type="measure"/>
                <field name="failed_cells" type="measure"/>
            </pivot>
        </field>
    </record>

    <record id="view_devops_notebook_run_list" model="ir.ui.view">
        <field name="name">devops.notebook.run.list</field>
        <field name="model">devops.notebook.run</field>
        <field name="arch" type="xml">
            <list string="执行历史" default_order="start_datetime desc">
                <field name="name"/>
                <field name="project_id"/>
                <field name="notebook_id"/>
                <field name="schedule_id"/>
                <field name="trigger_type"/>
                <field name="state"/>
                <field name="start_datetime"/>
                <field name="end_datetime"/>
                <field name="duration_seconds"/>
                <field name="user_id"/>
            </list>
        </field>
    </record>

    <record id="view_devops_notebook_run_form" model="ir.ui.view">
        <field name="name">devops.notebook.run.form</field>
        <field name="model">devops.notebook.run</field>
        <field name="arch" type="xml">
            <form string="执行详情">
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_open_mails"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-envelope">
                            <field name="mail_ids" widget="statinfo" string="邮件"/>
                        </button>
                    </div>
                    <group>
                <field name="name" readonly="1"/>
                <field name="project_id" readonly="1"/>
                <field name="notebook_id" readonly="1"/>
                <field name="schedule_id" readonly="1"/>
                <field name="trigger_type" readonly="1"/>
                <field name="state" readonly="1"/>
                <field name="user_id" readonly="1"/>
                    </group>
                    <group>
                        <field name="start_datetime" readonly="1"/>
                        <field name="end_datetime" readonly="1"/>
                        <field name="duration_seconds" readonly="1"/>
                        <field name="result_cell_total" readonly="1"/>
                        <field name="result_failed_cells" readonly="1"/>
                    </group>
                    <group>
                        <field name="message" readonly="1"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="view_devops_notebook_run_search" model="ir.ui.view">
        <field name="name">devops.notebook.run.search</field>
        <field name="model">devops.notebook.run</field>
        <field name="arch" type="xml">
            <search string="执行历史">
                <field name="notebook_id"/>
                <field name="schedule_id"/>
                <field name="project_id"/>
                <field name="user_id"/>
                <filter name="filter_failed" string="失败" domain="[('state', '=', 'failed')]"/>
                <filter name="filter_manual" string="手动" domain="[('trigger_type', '=', 'manual')]"/>
                <filter name="filter_schedule" string="定时" domain="[('trigger_type', '=', 'schedule')]"/>
                <group expand="0" string="分组">
                    <filter name="group_project" string="项目" context="{'group_by': 'project_id'}"/>
                    <filter name="group_notebook" string="笔记本" context="{'group_by': 'notebook_id'}"/>
                    <filter name="group_schedule" string="定时任务" context="{'group_by': 'schedule_id'}"/>
                    <filter name="group_state" string="状态" context="{'group_by': 'state'}"/>
                </group>
            </search>
        </field>
    </record>

    <record id="action_devops_notebook_run" model="ir.actions.act_window">
        <field name="name">执行历史</field>
        <field name="res_model">devops.notebook.run</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="view_devops_notebook_run_search"/>
    </record>

    <record id="action_devops_notebook" model="ir.actions.act_window">
        <field name="name">笔记本</field>
        <field name="res_model">devops.notebook</field>
        <field name="view_mode">list,form,kanban,graph,pivot</field>
        <field name="context">{'default_owner_id': uid}</field>
    </record>

    <!-- Project default notebook data source -->
    <record id="project_project_view_form_notebook_datasource" model="ir.ui.view">
        <field name="name">project.project.form.notebook.datasource</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="project.edit_project"/>
        <field name="arch" type="xml">
            <xpath expr="//page[@name='settings']//group" position="inside">
                <field name="notebook_data_source_id" options="{'no_create': False}"/>
            </xpath>
        </field>
    </record>

</odoo>
